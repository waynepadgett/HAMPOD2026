# Session Notes - December 5, 2025

## Summary
Spent ~1 hour debugging compilation issues and determining the state of the codebase. Key finding: **Firmware works, Software never actually compiled on the Raspberry Pi**.

---

## Current State

### Working ✅
- **Branch:** `rebuild/clean-dec3` 
- **Commit:** `c0eba12` (tip of branch)
- **Firmware:** Builds and runs successfully on Raspberry Pi
- **HAL Tests:** All Phase 1-3 integration tests pass
- **Keypad+Speech Test:** `Firmware/hal/tests/test_integration` works - press a key and it speaks the key name

### Not Working ❌
- **Software Layer:** Does not compile - has never been successfully built on the Raspberry Pi
- Multiple compilation errors exist in the Software layer

---

## Key Commits Reference

| Commit | Description | Status |
|--------|-------------|--------|
| `6e566a0` | Phase 3 Complete - all tests passing | ✅ Firmware works |
| `171fa80` | Docs update for Phase 1-3 completion | ✅ Safe |
| `32b50ab` | Phase 4 Makefile improvements | ⚠️ Software-only changes |
| `c0eba12` | Added Project Overview and Onboarding docs | ✅ Current (Firmware still works) |

---

## Software Layer Compilation Errors

These errors exist at commit `c0eba12` and need to be fixed:

### 1. Missing Include - `sendSpeakerOutput` not found
**File:** `Software/Modes/DummyDTMFMode.h`
**Fix:** Add `#include "../FirmwareCommunication.h"`

### 2. Pointer Dereference Error - `set_level()`
**File:** `Software/HamlibWrappedFunctions/HamlibSetFunctions.c` (line 323)
**Bug:** `setting_t setting_value = (setting_t*)((void**)input)[2];`
**Fix:** `setting_t setting_value = *((setting_t*)((void**)input)[2]);` (add `*`)

### 3. Wrong Argument Type - `convertCharToKeyValue()`
**File:** `Software/ConfigSettings/ConfigLoad.c` (line 109)
**Bug:** `convertCharToKeyValue(keyinput->keyPressed)` - passes `char` instead of `KeyPress*`
**Fix:** `convertCharToKeyValue(keyinput)`

### 4. Thread Function Return Type - `firmwarePlayAudio`
**File:** `Software/FirmwareCommunication.c`
**Issue:** `pthread_create` expects `void* (*)(void*)` but `firmwarePlayAudio` returns `int`
**Fix:** Create wrapper function:
```c
void* firmwarePlayAudioWrapper(void* text) {
    firmwarePlayAudio(text);
    return NULL;
}
```
Then use `firmwarePlayAudioWrapper` in `pthread_create` calls.

### 5. Callback Signature Mismatch
**Files:** `Software/RigListCreator.c` and `Software/RigListCreator.h`
**Bug:** Missing `const` in `callback` function signature
**Fix:** Change `int callback(struct rig_caps *caps, ...)` to `int callback(const struct rig_caps *caps, ...)`

---

## Build Process

### Correct Build Order (Critical!)
```bash
# 1. Build Firmware FIRST
cd ~/HAMPOD2026/Firmware && make clean && make

# 2. Build Software SECOND (once fixed)
cd ~/HAMPOD2026/Software && make clean && make
```

### Manual Sync from Windows to Pi (if needed)
```powershell
# From Windows PowerShell
tar -czf hampod_sync.tar.gz --exclude='.git' --exclude='.vscode' --exclude='hampod_sync*.tar.gz' .
scp hampod_sync.tar.gz waynesr@HAMPOD.local:~/
ssh waynesr@HAMPOD.local "cd ~/HAMPOD2026 && tar -xzf ~/hampod_sync.tar.gz && rm ~/hampod_sync.tar.gz"
```

### Using Git on Pi (preferred)
```powershell
ssh waynesr@HAMPOD.local "cd ~/HAMPOD2026 && git fetch --all && git checkout <branch>"
```

---

## Testing Integration

### Keypad + Speech Test (Interactive)
```bash
ssh waynesr@HAMPOD.local "cd ~/HAMPOD2026/Firmware/hal/tests && ./test_integration"
```
- Press keys on USB numpad
- Pi speaks the key names
- Ctrl+C to exit

### Phase 3 Audio Test
```bash
ssh waynesr@HAMPOD.local "cd ~/HAMPOD2026/Firmware/tests && ./test_phase3"
```

---

## Important Learnings

1. **The `#include "file.c"` Pattern**: This codebase uses a pattern where headers include their `.c` files at the end when `SHAREDLIB` is not defined. This affects how things compile.

2. **WiringPi Removed**: The migration to Raspberry Pi removed WiringPi dependency - using Linux input events for USB keypad instead.

3. **Software Layer Was Never Actually Tested**: The Phase 1-4 work focused on Firmware/HAL. The Software layer has pre-existing bugs that were never addressed.

4. **DNS Resolution on Windows**: `HAMPOD.local` sometimes fails to resolve on Windows. Just retry if SCP fails with hostname resolution error.

5. **Stash Before Checkout**: Always stash or clean before switching branches on the Pi - there are often build artifacts that conflict.

---

## Next Steps

1. **Priority 1:** Fix the 5 Software compilation errors listed above
2. **Priority 2:** Test Software builds on Pi
3. **Priority 3:** Test full integration (Firmware + Software)
4. **Priority 4:** Update documentation with working build instructions

---

## Files Added This Session
- `Documentation/scripts/remote_install.ps1` - PowerShell deploy script (needs work)
- This file: `Documentation/Project Overview and Onboarding/2025-12-5-notes.md`
